// Validate
//script(type='text/javascript', src='/javascripts/forms.js')

form#uploadForm.form-horizontal.center-content(method='post', enctype="multipart/form-data", action='https://whitewalls.s3.amazonaws.com/')
  fieldset
    legend Upload a Poster
    //a(href='/Multiupload') New, multi-pdf uploader!
    input(id='s3_policy', name='policy', type='hidden')
    input(id='s3_key', name='key', type='hidden')
    input(id='s3_AWSAccessKeyId', name='AWSAccessKeyId', type='hidden')
    input(id='s3_acl', name='acl', type='hidden')
    input(id='s3_success_action_redirect', name='success_action_redirect', type='hidden')
    //input(id='s3_success_action_status', name='success_action_status', type='hidden')
    input(id='s3_signature', name='signature', type='hidden')
    input(id='s3_Content-Type', name='Content-Type', type='hidden')
    //
      <input type="hidden" name="key" value="uploads/${filename}">
      <input type="hidden" name="AWSAccessKeyId" value="YOUR_AWS_ACCESS_KEY">
      <input type="hidden" name="acl" value="private">
      <input type="hidden" name="success_action_redirect" value="http://localhost/">
      <input type="hidden" name="policy" value="YOUR_POLICY_DOCUMENT_BASE64_ENCODED">
      <input type="hidden" name="signature" value="YOUR_CALCULATED_SIGNATURE">
      <input type="hidden" name="Content-Type" value="image/jpeg">
    //.control-group
      // MUST BE LAST!
      //label.control-label(for='uploadFile') File
      //.controls
    input#artworkName.required.input(type='text')
    input#uploadFile.required.input(name='file', type='file')
    .actions
      input.btn.btn-primary(type='submit', value='Upload', id='submitBtn2')
      button.btn(type='reset') Cancel

script(type='text/javascript')
  $(function() {
    function addIframe() {
      $('iframe').remove();
      var subframe = document.createElement('iframe');
      document.body.appendChild(subframe);
      //$('iframe').hide();
      subframe.src = "iframe.html";
    };
    addIframe();
    checkForSubmit = function() {
      var timeout = setInterval(function() {
        console.log($('iframe'));
        if ($('iframe').contents().length != 0) {
          // Not received yet
        } else {
          // Got a response!
          clearInterval(timeout);
          addIframe();
        }
      }, 100);
    }
    $( "#submitBtn2" ).click(function(event) {
      event.preventDefault();
      var _file = $("#uploadFile").val().replace(/.+[\\\/]/, "");
      var artworkName = $('#artworkName').val();

      _file = 'adsf';
      $.ajax({
        url: "/gets3credentials/" + _file + '/' + artworkName,
        dataType: "text",
        success: function(res, status) {
          res = JSON.parse(JSON.parse(res)); // TODO: WTF
          console.log(res);
          $('#s3_AWSAccessKeyId').val(res.s3KeyId);
          $('#s3_signature').val(res.s3Signature);
          $('#s3_policy').val(res.s3PolicyBase64);

          $('#s3_success_action_redirect').val(res.s3Redirect);
          //$('#s3_success_action_status').val(res.s3RedirectStatus);
          //$('#s3_key').val('${filename}');
          $('#s3_key').val(res.s3Key);
          $('#s3_acl').val(res.s3Acl);
          $('#s3_Content-Type').val(res.s3ContentType);
          //top.GLOBAL_sendFormData(formData);
          //top.GLOBAL_sendFormData();
          $('#uploadForm').submit();
          checkForSubmit();
        },
        error: function(res, status, error) {//do some error handling here
          console.log('error', res, status, error);
        }
      });
    });
  })
